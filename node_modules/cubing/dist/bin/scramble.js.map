{
  "version": 3,
  "sources": ["../../src/bin/scramble.ts"],
  "sourcesContent": ["/**\n\nTo run this file directly:\n\n```shell\nbun run -- ./src/bin/scramble.ts 333\n```\n\nTo test completions:\n\n```shell\n# fish (from repo root)\nset PATH (pwd)/src/test/bin-path $PATH\nscramble --completions fish | source\n```\n\n```shell\n# zsh (from repo root)\nautoload -Uz compinit\ncompinit\nexport PATH=$(pwd)/src/test/bin-path:$PATH\nsource <(scramble --completions zsh)\n```\n\n*/\n\nimport { basename } from \"node:path\";\nimport { argv } from \"node:process\";\nimport {\n  argument,\n  choice,\n  integer,\n  map,\n  merge,\n  message,\n  object,\n  option,\n  withDefault,\n} from \"@optique/core\";\nimport { run } from \"@optique/run\";\nimport type { Alg } from \"cubing/alg\";\nimport { eventInfo, twizzleEvents } from \"cubing/puzzles\";\nimport { randomScrambleForEvent } from \"cubing/scramble\";\nimport { setSearchDebug } from \"cubing/search\";\nimport { packageVersion } from \"../metadata/packageVersion\";\n\nconst outputFormats = [\"auto\", \"text\", \"link\", \"json-text\"] as const;\nconst notationTypes = [\"auto\", \"LGN\"] as const;\nconst eventIDs = Object.entries(twizzleEvents)\n  .filter(([_, eventInfo]) => !!eventInfo.scramblesImplemented)\n  .map(([eventID, _]) => eventID);\n\nconst args = run(\n  merge(\n    object({\n      amount: withDefault(\n        option(\"--amount\", \"-n\", integer({ metavar: \"AMOUNT\", min: 1 }), {\n          description: message`Amount of scrambles.`,\n        }),\n        1,\n      ),\n      notation: withDefault(\n        option(\"--notation\", choice(notationTypes, { metavar: \"NOTATION\" })),\n        \"auto\",\n      ),\n    }),\n    object({\n      format: withDefault(\n        option(\"--format\", \"-f\", choice(outputFormats, { metavar: \"FORMAT\" })),\n        \"auto\",\n      ),\n    }),\n    object({\n      // TODO: consolidate this with `format`: https://github.com/dahlia/optique/issues/57\n      text: map(\n        option(\"--text\", \"-t\", {\n          description: message`Convenient shorthand for \\`--format text\\`.`,\n        }),\n        () => \"text\",\n      ),\n    }),\n    object({\n      eventID: argument(choice(eventIDs, { metavar: \"EVENT_ID\" }), {\n        description: message`WCA or unoffiical event ID.`,\n      }),\n    }),\n  ),\n  {\n    programName: basename(argv[1]),\n    description: message`Example: order 3x3x3 \"R U R' U R U2' R'\"`,\n    help: \"option\",\n    completion: {\n      mode: \"option\",\n      name: \"plural\",\n    },\n    version: {\n      mode: \"option\",\n      value: packageVersion,\n    },\n  },\n);\n\nconst { amount, format: argsFormat, notation, text, eventID } = args;\nconst format = argsFormat ?? text ?? (!process.stdout.isTTY ? \"text\" : \"auto\");\n\nsetSearchDebug({ logPerf: false, showWorkerInstantiationWarnings: false });\n\nfunction scrambleText(scramble: Alg): string {\n  return scramble.toString({\n    // TODO: any\n    notation: notation as (typeof notationTypes)[number], // TODO: handle type conversion at arg parse time.\n  });\n}\n\nfunction scrambleLink(scramble: Alg): string {\n  const url = new URL(\"https://alpha.twizzle.net/edit/\");\n  const puzzleID = eventInfo(eventID)?.puzzleID;\n  puzzleID && url.searchParams.set(\"puzzle\", puzzleID);\n  url.searchParams.set(\"alg\", scrambleText(scramble));\n  return url.toString();\n}\n\nclass JSONListPrinter<T> {\n  #finished = false;\n  #firstValuePrintedAlready = false;\n  constructor() {\n    process.stdout.write(\"[\\n  \");\n  }\n\n  push(value: T) {\n    if (this.#firstValuePrintedAlready) {\n      process.stdout.write(\",\\n  \");\n    }\n    this.#firstValuePrintedAlready = true;\n    process.stdout.write(JSON.stringify(value));\n  }\n\n  finish() {\n    if (this.#finished) {\n      throw new Error(\"Tried to finish JSON list printing multiple times.\");\n    }\n    this.#finished = true;\n    console.log(\"\\n]\");\n  }\n}\n\n// Possibly: https://github.com/nodejs/node/issues/55468 Technically we could\n// just remove `await` from the called function, but this is semantically\n// unsound. This function encapsulates the unsoundness.\nfunction nodeForgetTopLevelAwaitWorkaround(\n  _promise: Promise<void>,\n): Promise<void> {\n  return Promise.resolve();\n}\n\nawait nodeForgetTopLevelAwaitWorkaround(\n  (async () => {\n    if (format !== \"json-text\" && amount === 1) {\n      const scramble = await randomScrambleForEvent(eventID);\n\n      switch (format) {\n        case \"auto\": {\n          console.log(`${scrambleText(scramble)}\n\n\uD83D\uDD17 ${scrambleLink(scramble)}`);\n          break;\n        }\n        case \"text\": {\n          console.log(scrambleText(scramble));\n          break;\n        }\n        case \"link\": {\n          console.log(scrambleLink(scramble));\n          break;\n        }\n        // @ts-expect-error This is a code guard for future refactoring.\n        case \"json-text\": {\n          throw new Error(\n            \"Encountered `json` format in code that is not expected to handle it.\",\n          );\n        }\n        default: {\n          throw new Error(\"Invalid format!\") as never;\n        }\n      }\n    } else {\n      const jsonListPrinter: JSONListPrinter<string> | undefined =\n        format === \"json-text\" ? new JSONListPrinter() : undefined;\n      for (let i = 0; i < amount; i++) {\n        const scramble = await randomScrambleForEvent(eventID);\n        switch (format) {\n          case \"auto\": {\n            console.log(`// Scramble #${i + 1}\n${scrambleText(scramble)}\n\n\uD83D\uDD17 ${scrambleLink(scramble)}\n`);\n            break;\n          }\n          case \"text\": {\n            console.log(`// Scramble #${i + 1}`);\n            console.log(`${scrambleText(scramble)}\\n`);\n            break;\n          }\n          case \"link\": {\n            console.log(`// Scramble #${i + 1}`);\n            console.log(`${scrambleLink(scramble)}\\n`);\n            break;\n          }\n          case \"json-text\": {\n            jsonListPrinter?.push(scramble.toString());\n            break;\n          }\n          default: {\n            throw new Error(\"Invalid format!\") as never;\n          }\n        }\n      }\n      jsonListPrinter?.finish();\n    }\n  })(),\n);\n"],
  "mappings": "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",
  "names": ["eventInfo", "eventID"]
}
